name: SCR Security Scans

on:
  push:
    branches:
      - staging
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  sast_bandit:
    name: SAST-Bandit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Install Bandit & Run Scan
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json || true

  sca_dependency_check:
    name: SCA-Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Run Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: django-nv
          path: '.'
          format: 'JSON'
          outputDirectory: './sca-reports'

  secrets_gitleaks:
    name: Secrets Scan - Gitleaks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Run Gitleaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks-linux-amd64 -o gitleaks
          chmod +x gitleaks
          ./gitleaks detect --source . --report-format json --report-path gitleaks-report.json || true

  container_trivy:
    name: Container Scan - Trivy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Install Trivy & Run Filesystem Scan
        run: |
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.49.1_Linux-64bit.deb
          sudo dpkg -i trivy_0.49.1_Linux-64bit.deb
          trivy fs . --format json --output trivy-container-report.json || true

  iac_trivy:
    name: IaC Scan - Trivy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Run Trivy IaC Scan
        run: |
          trivy config . --format json --output trivy-iac-report.json || true

  sbom_syft:
    name: SBOM - Syft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Install Syft
        run: |
          curl -sSLo syft.tar.gz https://github.com/anchore/syft/releases/download/v0.104.0/syft_0.104.0_linux_amd64.tar.gz
          tar -xzf syft.tar.gz syft
          chmod +x syft
          sudo mv syft /usr/local/bin/syft
      - name: Run SBOM Scan
        run: syft . -o json > syft-sbom.json

  upload_reports:
    name: Upload JSON Reports
    runs-on: ubuntu-latest
    needs: [sast_bandit, sca_dependency_check, secrets_gitleaks, container_trivy, iac_trivy, sbom_syft]
    steps:
      - name: Download All Reports
        uses: actions/checkout@v3
      - name: Upload Reports as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-json-reports
          path: |
            bandit-report.json
            gitleaks-report.json
            trivy-container-report.json
            trivy-iac-report.json
            syft-sbom.json
            ./sca-reports/dependency-check-report.json
